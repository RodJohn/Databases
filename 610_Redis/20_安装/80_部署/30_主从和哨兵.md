
# 3 主从复制

## 3.1 概念

    在主从复制中，数据库分为两类，一类是主数据库（master），另一类是从数据库(slave)。
    主数据库可以进行读写操作，当写操作导致数据变化时会自动将数据同步给从数据库。
    而从数据库一般是只读的，并接受主数据库同步过来的数据。
    一个主数据库可以拥有多个从数据库，而一个从数据库只能拥有一个主数据库。

## 3.3 特点    
    
    完整复制
    异步保存
    主数据库异常,只能手动将从数据库升级为主数据库


## 3.5 同步

### 3.5.1 全量同步

流程
    
    从服务器连接主服务器，发送PSYNC命令； 
    主服务器接收到PSYNC命名后，开始执行BGSAVE命令生成RDB文件并使用缓冲区记录此后执行的所有写命令； 
    主服务器BGSAVE执行完后，向所有从服务器发送快照文件，并在发送期间继续记录被执行的写命令； 
    从服务器收到快照文件后丢弃所有旧数据，载入收到的快照； 
    主服务器快照发送完毕后开始向从服务器发送缓冲区中的写命令； 
    从服务器完成对快照的载入，开始接收命令请求，并执行来自主服务器缓冲区的写命令； 

情景

    Redis全量复制一般发生在Slave初始化阶段，这时Slave需要将Master上的所有数据都复制一份。

### 3.5.3 增量同步

原因

    SYNC在断线重连的情况下,效率低
    2.8版以后提供PSYNC替代SYNC

积压缓冲区

    主服务器中存放一个复制积压缓冲区
    这是一个固定大小的FIFO队列，当队列已满时会弹出最早插入的数据，

    主服务器进行命令传播时会同时把命令放到缓冲区中，
    缓冲区包含两部分数据，偏移量和字节。
    
    在进行复制时从服务器会将偏移量上报到主服务器，主服务检查当前偏移量是否还存在缓冲区中，
    如果存在进行部分重同步，如果不存在进行完整重同步。
    
    
运行ID

    初次同步时主服务器会把ID发给从服务器，从服务器保存主服务器ID，
    当断线重连后，会把之前保存的主服务器ID上报给主服务器，主服务器检查从服务器之前复制的主服务器ID是否和自己的ID相同   

## 3.6 传播

    当客户端发送写执行给主，主执行完立即将结果返回客户端，并异步的把命令发送给从，从而不影响性能。 

## 3.8 配置

    1.从redis的conf文件加入 slaveof ip port  (重启以后有效)
    2.或者从redis启动时  redis-server --port 6380 --slaveof 127.0.0.1 6379 
    3.设置从机只读    
    
## 3.9 风险

    在进行主从复制设置时，强烈建议在主服务器上开启持久化，当不能这么做时，比如考虑到延迟的问题，应该将实例配置为避免自动重启。
     
    为什么不持久化的主服务器自动重启非常危险呢？
    为了更好的理解这个问题，看下面这个失败的例子，其中主服务器和从服务器中数据库都被删除了。
     
    设置节点A为主服务器，关闭持久化，节点B和C从节点A复制数据。
    这时出现了一个崩溃，但Redis具有自动重启系统，重启了进程，因为关闭了持久化，节点重启后只有一个空的数据集。
    节点B和C从节点A进行复制，现在节点A是空的，所以节点B和C上的复制数据也会被删除。
    当在高可用系统中使用Redis Sentinel，关闭了主服务器的持久化，并且允许自动重启，这种情况是很危险的。
    比如主服务器可能在很短的时间就完成了重启，以至于Sentinel都无法检测到这次失败，那么上面说的这种失败的情况就发生了。
     
    如果数据比较重要，并且在使用主从复制时关闭了主服务器持久化功能的场景中，都应该禁止实例自动重启。


# 4 哨兵


## 4.1 概念

    哨兵的作用就是监控redis主、从数据库是否正常运行，
    主出现故障自动将从数据库转换为主数据库。
    

## 4.2 特点

    基于主从复制
    可以启用多个哨兵

## 4.8 配置

    1.主从
        设置1主二从
        redis-server --port 6379 
        redis-server --port 6380 --slaveof 192.168.0.167 6379 
        redis-server --port 6381 --slaveof 192.168.0.167 6379   
    2.哨兵
        设置配置文件
        sentinel.conf 
            sentinel monitor mymaster 192.168.0.167 6379 1 
        启动哨兵
        redis-sentinel sentinel.conf 





# 参考
       
       
       https://yq.aliyun.com/articles/57953                                                       