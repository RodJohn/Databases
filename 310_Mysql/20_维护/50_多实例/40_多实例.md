
# 1 概述

概述

    在一台服务器上安装多个MySQL数据库实例
    mysqld_multi管理多实例

作用
    
    充分利用硬件资源 
    SSD下IO资源过剩 
    CPU过剩


# 参数配置

注意

    该三个参数必须定制，且必须不同 (port / datadir / socket) 
    server-id和多数据库实例没有关系，和数据库复制有关系。

mysqld_multi

    
    配置[mysqld_multi]标签后
    mysqld_multi start 1 是用mysqld_safe启动守护进程的形式启动

停止mysql实例

    multi_admin用户的作用 
    通过官方文档中我们看到，'multi_admin'@'localhost'这个用户主要的作用是用来关闭数据库实例，因为文档中只授权了SHUTDOWN权限。所以在[mysqld_multi]标签下，我们需要配置user和password(注意5.7.9中是pass)来进行关闭数据库实例。
    
    [client]标签 
    从操作演示来看，老师并没有在[mysqld_multi]下配置user和password，但是仍然可以关闭数据库，原因是因为/root/.my.cnf中存在了[client]标签。
    该标签下的用户user = root有关闭数据库实例的权限，因此可以关闭数据库。
    如果在[client]和[mysqld_multi]标签中同时存在user和password, 则在关闭数据库实例中会使用[mysqld_multi]中的user去关闭。 
    (存在精确匹配的标签，则优先使用精确匹配标签下的配置项)
    
    
## 示例

    #
    # 多实例配置文件，可以mysqld_multi --example 查看例子
    #
    [root@MyServer /]> cat /etc/my.cnf 
    #[client]           # 这个标签如果配置了用户和密码，
                        # 并且[mysqld_multi]下没有配置用户名密码，
                        # 则mysqld_multi stop时, 会使用这个密码
                        # 如果没有精确的匹配，则匹配[client]标签
    #user = root        
    #password = 123
    #-------------
    [mysqld_multi]
    mysqld = /usr/local/mysql/bin/mysqld_safe
    mysqladmin = /usr/local/mysql/bin/mysqladmin
    user = multi_admin
    pass = 123  # 官方文档中写的password，但是存在bug，需要改成pass(v5.7.9)
                # 写成password，start时正常，stop时，报如下错误
                # Access denied for user 'multi_admin'@'localhost' (using password: YES)
    log = /var/log/mysqld_multi.log
    
    
    [mysqld1]  # mysqld后面的数字为GNR, 是该实例的标识
               # mysqld_multi  start 1,  mysqld_multi start 2-4
    server-id = 11
    socket = /tmp/mysql.sock1
    port = 3306
    bind_address = 0.0.0.0
    datadir = /data1
    user = mysql
    performance_schema = off
    innodb_buffer_pool_size = 32M
    skip_name_resolve = 1
    log_error = error.log
    pid-file = /data1/mysql.pid1
    
    
    [mysqld2]
    server-id = 12
    socket = /tmp/mysql.sock2
    port = 3307
    bind_address = 0.0.0.0
    datadir = /data2
    user = mysql
    performance_schema = off
    innodb_buffer_pool_size = 32M
    skip_name_resolve = 1
    log_error = error.log
    pid-file = /data2/mysql.pid2
    
    
    [mysqld3]
    server-id = 13
    socket = /tmp/mysql.sock3
    port = 3308
    bind_address = 0.0.0.0
    datadir = /data3
    user = mysql
    performance_schema = off
    innodb_buffer_pool_size = 32M
    skip_name_resolve = 1
    log_error = error.log
    pid-file = /data3/mysql.pid3
    
    
    [mysqld4]
    server-id = 14
    socket = /tmp/mysql.sock4
    port = 3309
    bind_address = 0.0.0.0
    datadir = /data4
    user = mysql
    performance_schema = off
    innodb_buffer_pool_size = 32M
    skip_name_resolve = 1
    log_error = error.log
    pid-file = /data4/mysql.pid4



# 数据文件

    [root@MyServer ~]> mkdir /data1
    [root@MyServer ~]> mkdir /data2
    [root@MyServer ~]> mkdir /data3
    [root@MyServer ~]> mkdir /data4
    [root@MyServer ~]> chown mysql.mysql /data{1..4}
    
    
    
# 初始化
 
    [root@MyServer ~]> mysqld --initialize --user=mysql --datadir=/data1
    #
    # 一些日志输出，并提示临时密码，下同
    #
    [root@MyServer ~]> mysqld --initialize --user=mysql --datadir=/data2
    [root@MyServer ~]> mysqld --initialize --user=mysql --datadir=/data3
    [root@MyServer ~]> mysqld --initialize --user=mysql --datadir=/data4
    # 安装后，需要检查error.log 确保没有错误出现
    
# 启动优化
    
    [root@MyServer ~]> cp /usr/local/mysql/support-files/mysqld_multi.server  /etc/init.d/mysqld_multid 
    # 拷贝启动脚本，方便自启
    [root@MyServer ~]> chkconfig mysqld_multid on

# 控制
    
启动
    
    mysqld_multi  start 1    
    mysqld_multi  start   
    
查看日志

    [root@MyServer ~]> mysqld_multi  report
    Reporting MySQL servers
    MySQL server from group: mysqld1 is running
    MySQL server from group: mysqld2 is running
    MySQL server from group: mysqld3 is running
    MySQL server from group: mysqld4 is running    
    
    
登录
    
    [root@MyServer ~]> mysql -u root [-S /tmp/mysql.sock1 | -p -P3306 ]   
    
    
关闭

    --
    -- 这样才能进行关闭数据库的操作
    -- 和[mysqld_multi]中的user，pass(注意在5.7.9中不是password)对应起来 （类比[client]标签）
    -- 一会测试federated链接，需要增加federated参数，并重启mysql2
    --
    mysql> create user 'multi_admin'@'localhost' identified by '123';
    Query OK, 0 rows affected (0.00 sec)
    mysql> grant shutdown on *.* to 'multi_admin'@'localhost';      




